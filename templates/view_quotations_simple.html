<!DOCTYPE html>
<html>
<head>
    <style>
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .title-version {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .version-tag {
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            color: #495057;
        }
        
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        
        .refresh-btn:hover {
            background: #0056b3;
        }
        
        .quotation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .quotation-table th,
        .quotation-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }
        
        .quotation-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .table-container {
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            margin: 0 20px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        /* Zebra striping */
        .quotation-table tr:nth-child(even) {
            background-color: #fafafa;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .table-container {
                margin: 0 10px;
            }
            
            .quotation-table th,
            .quotation-table td {
                padding: 8px;
                font-size: 0.9em;
            }
        }

        /* Creator email style */
        .creator-email {
            color: #666;
            font-size: 0.9em;
        }

        /* Timestamp styles */
        .timestamp {
            white-space: nowrap;
            color: #666;
            font-size: 0.9em;
        }

        /* Sticky/frozen columns */
        .quotation-table th.sticky,
        .quotation-table td.sticky {
            position: sticky;
            background: #fff !important;
            z-index: 100;
            background-clip: padding-box;
            border-right: 2px solid #fff;
        }
        .sticky-id { left: 0; z-index: 101; max-width: 70px; min-width: 60px; overflow: hidden; white-space: nowrap; background: #fff !important; }
        .sticky-customer { left: 70px; z-index: 102; max-width: 180px; min-width: 160px; overflow: hidden; white-space: nowrap; background: #fff !important; }
        .sticky-keyperson { left: 250px; z-index: 103; max-width: 200px; min-width: 180px; overflow: hidden; white-space: nowrap; background: #fff !important; }
        .sticky-itemcode { left: 450px; z-index: 104; max-width: 160px; min-width: 140px; overflow: hidden; white-space: nowrap; background: #fff !important; }
        .sticky-artwork { left: 610px; z-index: 105; max-width: 140px; min-width: 120px; overflow: hidden; background: #fff !important; }
        .sticky-status { left: 750px; z-index: 106; max-width: 100px; min-width: 80px; overflow: hidden; white-space: nowrap; background: #fff !important; box-shadow: 2px 0 6px -2px #bbb; }
        .sticky-action { left: 850px; z-index: 107; max-width: 100px; min-width: 80px; overflow: hidden; white-space: nowrap; background: #fff !important; box-shadow: 2px 0 6px -2px #bbb; }

        .quotation-table th {
            position: sticky;
            top: 0;
            z-index: 200;
            background: #fff !important;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="header-container">
        <div class="title-version">
            <h2 style="margin: 0;">Quotation Records</h2>
            <span class="version-tag">v1.3.09</span>
        </div>
        <button class="refresh-btn" onclick="loadData()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 3a5 5 0 0 0-5 5H1l3.5 3.5L8 8H6a2 2 0 1 1 2 2v2a4 4 0 1 0-4-4H2a6 6 0 1 1 6 6v-2a4 4 0 0 0 0-8z"/>
            </svg>
            Refresh Data
        </button>
    </div>
    
    <div class="table-container">
        <table class="quotation-table">
            <thead>
                <tr>
                    <th class="sticky sticky-id" style="left:0;top:0;z-index:201;background:#fff;">ID</th>
                    <th class="sticky sticky-customer" style="left:70px;top:0;z-index:202;background:#fff;">Customer</th>
                    <th class="sticky sticky-keyperson" style="left:250px;top:0;z-index:203;background:#fff;">Key Person</th>
                    <th class="sticky sticky-itemcode" style="left:450px;top:0;z-index:204;background:#fff;">Item Code</th>
                    <th class="sticky sticky-artwork" style="left:610px;top:0;z-index:205;background:#fff;">Artwork</th>
                    <th class="sticky sticky-status" style="left:750px;top:0;z-index:206;background:#fff;box-shadow:2px 0 6px -2px #bbb;">Status</th>
                    <th class="sticky sticky-action" style="left:850px;top:0;z-index:207;background:#fff;box-shadow:2px 0 6px -2px #bbb;">Action</th>
                    <th>Creator</th>
                    <th>Quality</th>
                    <th>Flat/Raised</th>
                    <th>Direct/Reverse</th>
                    <th>Thickness</th>
                    <th># Colors</th>
                    <th>Length</th>
                    <th>Width</th>
                    <th>Price</th>
                    <th>Created</th>
                    <th>Last Updated</th>
                </tr>
            </thead>
            <tbody id="quotation-table-body">
            </tbody>
        </table>
    </div>

    <script>
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function formatCreatorEmail(email) {
            if (!email) return '';
            const atIndex = email.indexOf('@');
            if (atIndex > 0) {
                return email.substring(0, atIndex);
            }
            return email;
        }

        function formatPrice(price) {
            if (price === null || price === undefined || price === '') return '-';
            return parseFloat(price).toFixed(2);
        }

        function createTableRows(data) {
            if (!data || data.length === 0) {
                return '<tr><td colspan="16" style="text-align: center;">No quotation records found.</td></tr>';
            }

            return data.map(row => `
                <tr>
                    <td class="sticky sticky-id">${row.id || ''}</td>
                    <td class="sticky sticky-customer">${row.customer_name || ''}</td>
                    <td class="sticky sticky-keyperson">${row.key_person_name || ''}</td>
                    <td class="sticky sticky-itemcode" style="font-family: monospace;">${row.customer_item_code || ''}</td>
                    <td class="sticky sticky-artwork">${row.artwork_image ? `<img src="/${row.artwork_image.replace(/^uploads\//, 'uploads/')}" style="max-width:100%;max-height:60px;object-fit:contain;display:block;margin:auto;border:1px solid #ccc;border-radius:4px;" loading="lazy">` : ''}</td>
                    <td class="sticky sticky-status">${row.status || '-'}</td>
                    <td class="sticky sticky-action" style="overflow:visible;">${row.action ? `<button class='action-btn' data-id='${row.id}'>Action</button>` : '-'}</td>
                    <td class="creator-email">${formatCreatorEmail(row.creator_email) || ''}</td>
                    <td>${row.quality || ''}</td>
                    <td>${row.flat_or_raised || ''}</td>
                    <td>${row.direct_or_reverse || ''}</td>
                    <td>${row.thickness || ''}</td>
                    <td>${row.num_colors || ''}</td>
                    <td>${row.length || ''}</td>
                    <td>${row.width || ''}</td>
                    <td>${formatPrice(row.price)}</td>
                    <td class="timestamp">${formatDate(row.created_at)}</td>
                    <td class="timestamp">${formatDate(row.last_updated)}</td>
                </tr>
            `).join('');
        }

        function loadData() {
            fetch('/quotation/list')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    document.getElementById('quotation-table-body').innerHTML = createTableRows(data);
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                    document.getElementById('quotation-table-body').innerHTML = 
                        `<tr><td colspan="16" style="text-align: center; color: red;">Error loading data: ${error.message}</td></tr>`;
                });
        }

        // Load data when page loads
        loadData();

        // Add JS to create a floating dropdown menu in the document body
        (function() {
            let openDropdown = null;
            let openBtn = null;
            function closeDropdown() {
                if (openDropdown) {
                    document.body.removeChild(openDropdown);
                    openDropdown = null;
                    openBtn = null;
                }
            }
            document.addEventListener('click', function(e) {
                if (openDropdown && (!e.target.classList.contains('action-btn') && !e.target.classList.contains('action-dropdown-item'))) {
                    closeDropdown();
                }
            });
            document.addEventListener('scroll', closeDropdown, true);
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('action-btn')) {
                    closeDropdown();
                    openBtn = e.target;
                    const id = openBtn.getAttribute('data-id');
                    const rect = openBtn.getBoundingClientRect();
                    openDropdown = document.createElement('div');
                    openDropdown.className = 'action-dropdown';
                    openDropdown.style.position = 'fixed';
                    openDropdown.style.left = rect.left + 'px';
                    openDropdown.style.top = (rect.bottom + 4) + 'px';
                    openDropdown.style.background = '#fff';
                    openDropdown.style.border = '1px solid #ccc';
                    openDropdown.style.borderRadius = '6px';
                    openDropdown.style.boxShadow = '0 4px 16px rgba(0,0,0,0.18)';
                    openDropdown.style.zIndex = '99999';
                    openDropdown.style.minWidth = '180px';
                    openDropdown.innerHTML = `
                        <div class='action-dropdown-item' data-action='view' data-id='${id}' style='padding:10px 18px;cursor:pointer;'>View</div>
                        <div class='action-dropdown-item' data-action='edit' data-id='${id}' style='padding:10px 18px;cursor:pointer;'>Edit</div>
                        <div class='action-dropdown-item' data-action='send-email' data-id='${id}' style='padding:10px 18px;cursor:pointer;'>Send Email</div>
                        <div class='action-dropdown-item' data-action='price-approved' data-id='${id}' style='padding:10px 18px;cursor:pointer;'>Price Approved</div>
                        <div class='action-dropdown-item' data-action='start-sampling' data-id='${id}' style='padding:10px 18px;cursor:pointer;'>Start Sampling</div>
                    `;
                    document.body.appendChild(openDropdown);
                    e.stopPropagation();
                }
            });
        })();
    </script>
</body>
</html> 