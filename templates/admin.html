<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Approval - Customer Management App</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .tab-content { background: #fff; padding: 32px 40px; border-radius: 10px; box-shadow: 0 2px 16px #eee; min-width: 600px; }
    .nav-tabs { justify-content: center; margin-bottom: 0; }
    .nav-tabs .nav-link { font-size: 18px; padding: 10px 32px; }
    .container { margin-top: 40px; display: flex; flex-direction: column; align-items: center; }
    h2 { margin-bottom: 24px; }
    #rules-list .rule-content { width: 220px !important; min-width: 220px; max-width: 220px; }
    #rules-list .rule-add, #rules-list .rule-del { width: 36px; min-width: 36px; max-width: 36px; text-align: center; padding-left: 0; padding-right: 0; }
    #rules-section-flex { display: flex; gap: 48px; align-items: flex-start; }
    .rules-panel, .convert-panel {
      background: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 2px 8px #e0e0e0;
      padding: 24px 20px 20px 20px;
      min-width: 340px;
      max-width: 520px;
      flex: 1;
    }
    .convert-panel {
      min-width: 240px;
      max-width: 400px;
      border-left: 3px solid #e0e0e0;
    }
    .convert-disabled {
      pointer-events: none;
      opacity: 0.5;
      filter: grayscale(0.2);
    }
    #updating-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 18px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Admin User Approvals</h2>
  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="authorized-person-tab" data-toggle="tab" href="#authorized-person" role="tab">Authorized Person</a>
    </li>
  </ul>
  <div class="tab-content w-100" id="adminTabContent">
    <div class="tab-pane fade show active" id="authorized-person" role="tabpanel">
      <h3>Authorized Persons</h3>
      <div id="rules-section-flex">
        <div class="rules-panel" style="overflow-x:auto;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <label style="font-weight:600; font-size:1.1rem; margin-bottom:0;">Rules</label>
            <button class="btn btn-primary btn-sm rule-search">Search</button>
            <button class="btn btn-secondary btn-sm rule-cancel">Reset</button>
          </div>
          <div id="rules-list"></div>
        </div>
        <div class="convert-panel">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <label style="font-weight:600; font-size:1.1rem; margin-bottom:0;">Convert to</label>
            <button class="btn btn-success btn-sm convert-change-btn">Change</button>
            <button class="btn btn-secondary btn-sm convert-reset-btn" style="margin-left:8px;">Reset</button>
          </div>
          <div id="convert-to-box"></div>
        </div>
      </div>
      <div id="user-filter-row" style="margin-bottom:12px;display:flex;align-items:center;gap:16px;">
        <input id="user-filter-input" class="form-control" style="width:220px;display:inline-block;" placeholder="Filter by email...">
        <button class="btn btn-secondary btn-sm" id="batch-set-level">Set Level for Selected</button>
        <select id="batch-level-select" class="form-control" style="width:180px;display:inline-block;">
          <option value="">-- Select Level --</option>
          <option value="none">-- No Level --</option>
          <option value="1">Level 1 (Add/Edit)</option>
          <option value="2">Level 2 (Add/Edit/Delete)</option>
          <option value="3">Level 3 (Admin)</option>
        </select>
      </div>
      <table class="table" id="users-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all-users"></th>
            <th>Email</th>
            <th>Status</th>
            <th>Permission Level</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal" tabindex="-1" role="dialog" id="userModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userModalTitle">Add User</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <div class="form-group">
            <label for="userEmail">Email</label>
            <input type="email" class="form-control" id="userEmail" required>
          </div>
          <div class="form-group">
            <label for="userLevel">Permission Level</label>
            <select class="form-control" id="userLevel">
              <option value="1">Level 1 (Add/Edit)</option>
              <option value="2">Level 2 (Add/Edit/Delete)</option>
              <option value="3">Level 3 (Admin)</option>
            </select>
          </div>
          <input type="hidden" id="userId">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveUserBtn">Save</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- jQuery (required for Bootstrap 4) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Custom App JS -->
<script src="/static/js/app.js"></script>
<script>
// --- Rules UI Logic ---
const ruleNameOptions = [
  { value: 'email', label: 'Email' },
  { value: 'status', label: 'Status' },
  { value: 'permission', label: 'Permission Level' }
];
const ruleConditionOptions = [
  { value: 'contains', label: 'contains' },
  { value: 'not_contains', label: 'not contains' },
  { value: 'starts_with', label: 'starts with' },
  { value: 'ends_with', label: 'ends with' },
  { value: 'equal', label: 'equal to' },
  { value: 'not_equal', label: 'not equal' }
];
const ruleStatusOptions = [
  { value: 'Active', label: 'Active' },
  { value: 'Inactive', label: 'Inactive' },
  { value: 'Pending', label: 'Pending' }
];
const rulePermOptions = [
  { value: '1', label: 'Level 1 (Add/Edit)' },
  { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
  { value: '3', label: 'Level 3 (Admin)' }
];
let rules = [ { name: '', condition: '', content: '' } ];
function renderRules() {
  const $list = $('#rules-list');
  $list.empty();
  const usedNames = rules.map(r => r.name);
  rules.forEach((rule, idx) => {
    // Only show unused names (except for this rule's current name)
    const availableNames = ruleNameOptions.filter(opt => !usedNames.includes(opt.value) || opt.value === rule.name);
    const nameSelect = `<select class=\"rule-name form-control\" style=\"width:140px;display:inline-block;\"><option value=""></option>${availableNames.map(opt => `<option value=\"${opt.value}\"${rule.name===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    // Condition options depend on name
    let condOpts = ruleConditionOptions;
    if (rule.name === 'status' || rule.name === 'permission') {
      condOpts = ruleConditionOptions.filter(opt => opt.value === 'equal' || opt.value === 'not_equal');
    }
    const condSelect = `<select class=\"rule-cond form-control\" style=\"width:140px;display:inline-block;\"><option value=""></option>${condOpts.map(opt => `<option value=\"${opt.value}\"${rule.condition===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    let contentField = '';
    if (rule.name === 'email') {
      contentField = `<input type=\"text\" class=\"rule-content form-control\" style=\"width:220px;display:inline-block;\" value=\"${rule.content||''}\">`;
    } else if (rule.name === 'status') {
      contentField = `<select class=\"rule-content form-control\" style=\"width:220px;display:inline-block;\"><option value=""></option>${ruleStatusOptions.map(opt => `<option value=\"${opt.value}\"${rule.content===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    } else if (rule.name === 'permission') {
      contentField = `<select class=\"rule-content form-control\" style=\"width:220px;display:inline-block;\"><option value=""></option>${rulePermOptions.map(opt => `<option value=\"${opt.value}\"${rule.content==opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    }
    let addBtn = '';
    let delBtn = '';
    if (idx === rules.length - 1) {
      addBtn = `<button class=\"btn btn-success btn-sm rule-add\" style=\"margin-left:8px;\">+</button>`;
      delBtn = idx > 0 ? `<button class=\"btn btn-danger btn-sm rule-del\" style=\"margin-left:4px;\">-</button>` : '';
    } else {
      delBtn = `<button class=\"btn btn-danger btn-sm rule-del\" style=\"margin-left:4px;\">-</button>`;
    }
    $list.append(`<div class=\"rule-row\" data-idx=\"${idx}\" style=\"display:flex;align-items:center;gap:8px;margin-bottom:8px;\">${nameSelect}${condSelect}${contentField}${addBtn}${delBtn}</div>`);
  });
}
$(document).ready(function() {
  $('.convert-panel').addClass('convert-disabled');
  renderRules();
  $('#rules-list').on('change', '.rule-name', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    rules[idx].name = $(this).val();
    // Reset content when name changes
    rules[idx].content = '';
    renderRules();
  });
  $('#rules-list').on('change', '.rule-cond', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    rules[idx].condition = $(this).val();
  });
  $('#rules-list').on('input change', '.rule-content', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    rules[idx].content = $(this).val();
  });
  $('#rules-list').on('click', '.rule-add', function() {
    // Validate all fields before adding a new rule
    let allFilled = true;
    $('#rules-list .rule-row').each(function() {
      $(this).find('.form-control').css('background','');
      const name = $(this).find('.rule-name').val();
      const cond = $(this).find('.rule-cond').val();
      const content = $(this).find('.rule-content').val();
      if (!name || !cond || !content) {
        allFilled = false;
        if (!name) $(this).find('.rule-name').css('background','#ffd6d6');
        if (!cond) $(this).find('.rule-cond').css('background','#ffd6d6');
        if (!content) $(this).find('.rule-content').css('background','#ffd6d6');
      }
    });
    if (!allFilled) {
      alert('Please fill in all fields for every rule.');
      return;
    }
    // Find first unused name
    const usedNames = rules.map(r => r.name);
    let nextName = '';
    for (const opt of ruleNameOptions) {
      if (!usedNames.includes(opt.value)) {
        nextName = opt.value;
        break;
      }
    }
    let newRule = { name: nextName, condition: '', content: '' };
    // Negation logic for new rule content
    let prev = rules[rules.length-1];
    if (prev.name === 'status') {
      if (prev.content === 'Active') newRule.content = 'Inactive';
      else if (prev.content === 'Inactive') newRule.content = 'Active';
      else if (prev.content === 'Pending') newRule.content = 'Active';
      else newRule.content = 'Inactive';
    } else if (prev.name === 'permission') {
      if (prev.content === '1') newRule.content = '2';
      else if (prev.content === '2') newRule.content = '3';
      else if (prev.content === '3') newRule.content = '1';
      else newRule.content = '2';
    }
    rules.push(newRule);
    renderRules();
  });
  $('#rules-list').on('click', '.rule-del', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    if (confirm('Are you sure you want to delete this rule?')) {
      rules.splice(idx, 1);
      renderRules();
    }
  });
  $(document).on('click', '.rule-search', function() {
    let allFilled = true;
    $('#rules-list .rule-row').each(function() {
      $(this).find('.form-control').css('background','');
      const name = $(this).find('.rule-name').val();
      const cond = $(this).find('.rule-cond').val();
      const content = $(this).find('.rule-content').val();
      if (!name || !cond || !content) {
        allFilled = false;
        if (!name) $(this).find('.rule-name').css('background','#ffd6d6');
        if (!cond) $(this).find('.rule-cond').css('background','#ffd6d6');
        if (!content) $(this).find('.rule-content').css('background','#ffd6d6');
      }
    });
    if (!allFilled) {
      alert('Please fill in all fields for every rule.');
      return;
    }
    // Send rules to backend for filtering
    $.ajax({
      url: '/admin/users/filter',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ rules }),
      success: function(res) {
        // Update user table with filtered results
        updateUserTable(res.users);
      },
      error: function() {
        alert('Error filtering users.');
      }
    });
  });
  $(document).on('click', '.rule-cancel', function() {
    window.location.href = '/admin';
  });
});

function updateUserTable(users) {
  // Always select all after search
  const $tbody = $('#users-table tbody');
  $tbody.empty();
  if (!users.length) {
    $tbody.append('<tr><td colspan="5" class="text-center">No users found.</td></tr>');
    $('.convert-panel').addClass('convert-disabled');
    return;
  }
  $('.convert-panel').removeClass('convert-disabled');
  users.forEach(u => {
    // Compute status
    let status = 'Pending';
    if (u.is_approved === 0) status = 'Inactive';
    else if (u.is_approved === 1) status = 'Active';
    // Render permission level
    let levelDisplay = 'No Level';
    if (u.permission_level == 1) levelDisplay = 'Level 1 (Add/Edit)';
    if (u.permission_level == 2) levelDisplay = 'Level 2 (Add/Edit/Delete)';
    if (u.permission_level == 3) levelDisplay = 'Level 3 (Admin)';
    $tbody.append(`
      <tr${!u.permission_level ? ' style=\"background:#fffbe6\"' : ''}>
        <td><input type=\"checkbox\" class=\"user-select-checkbox\" data-id=\"${u.id}\" data-email=\"${u.email}\" data-level=\"${u.permission_level || ''}\"></td>
        <td>${u.email}</td>
        <td>${status}</td>
        <td>
          <select class=\"form-control user-level-select\" data-id=\"${u.id}\" data-original=\"${u.permission_level || ''}\" ${u.is_approved === 0 ? 'disabled' : ''}>
            <option value=\"\"${!u.permission_level ? ' selected' : ''}>No Level</option>
            <option value=\"1\"${u.permission_level==1?' selected':''}>Level 1 (Add/Edit)</option>
            <option value=\"2\"${u.permission_level==2?' selected':''}>Level 2 (Add/Edit/Delete)</option>
            <option value=\"3\"${u.permission_level==3?' selected':''}>Level 3 (Admin)</option>
          </select>
        </td>
        <td>
          <button class=\"btn btn-sm btn-success update-user-btn\" data-id=\"${u.id}\" data-email=\"${u.email}\" disabled ${u.is_approved === 0 ? 'disabled' : ''}>Update</button>
          ${(u.permission_level != 3 && u.is_approved !== 0) ? `<button class=\"btn btn-sm btn-warning inactive-user-btn\" data-id=\"${u.id}\">Inactive</button>` : ''}
        </td>
      </tr>
    `);
  });
  // Select all checkboxes and set select-all to checked
  $('#select-all-users').prop('checked', true);
  $('.user-select-checkbox:enabled').prop('checked', true);
}

// --- Convert to Preset Rule Logic ---
const convertNameOptions = [
  { value: 'status', label: 'Status' },
  { value: 'permission', label: 'Permission Level' }
];
const convertStatusOptions = [
  { value: 'Active', label: 'Active' },
  { value: 'Inactive', label: 'Inactive' }
];
const convertPermOptions = [
  { value: '1', label: 'Level 1 (Add/Edit)' },
  { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
  { value: '3', label: 'Level 3 (Admin)' }
];
function renderConvertToRule() {
  let name = window.convertToName || '';
  let content = window.convertToContent || '';
  let nameSelect = `<select id=\"convert-to-name\" class=\"form-control\" style=\"width:160px;display:inline-block;\"><option value=\"\"></option>${convertNameOptions.map(opt => `<option value=\"${opt.value}\"${name===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
  let condText = '<span style=\"width:40px;display:inline-block;text-align:center;font-weight:600;\">=</span>';
  let contentSelect = '';
  if (name === 'status') {
    contentSelect = `<select id=\"convert-to-content\" class=\"form-control\" style=\"width:180px;display:inline-block;\"><option value=\"\"></option>${convertStatusOptions.map(opt => `<option value=\"${opt.value}\"${content===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
  } else if (name === 'permission') {
    contentSelect = `<select id=\"convert-to-content\" class=\"form-control\" style=\"width:220px;display:inline-block;\"><option value=\"\"></option>${convertPermOptions.map(opt => `<option value=\"${opt.value}\"${content===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
  } else {
    contentSelect = `<select id=\"convert-to-content\" class=\"form-control\" style=\"width:180px;display:inline-block;\" disabled><option value=\"\"></option></select>`;
  }
  $('#convert-to-box').html(`<div style=\"display:flex;align-items:center;gap:8px;\">${nameSelect}${condText}${contentSelect}</div>`);
}
$(document).ready(function() {
  $('.convert-panel').addClass('convert-disabled');
  renderRules();
  renderConvertToRule();
  $(document).on('change', '#convert-to-name', function() {
    window.convertToName = $(this).val();
    window.convertToContent = '';
    renderConvertToRule();
  });
  $(document).on('change', '#convert-to-content', function() {
    window.convertToContent = $(this).val();
  });
  $(document).on('click', '.convert-reset-btn', function() {
    window.convertToName = '';
    window.convertToContent = '';
    renderConvertToRule();
  });
  $(document).on('click', '.convert-change-btn', function() {
    if ($('.convert-panel').hasClass('convert-disabled')) return;
    const name = $('#convert-to-name').val();
    const value = $('#convert-to-content').val();
    // Reset backgrounds
    $('#convert-to-name').css('background', '');
    $('#convert-to-content').css('background', '');
    if (!name) $('#convert-to-name').css('background', '#ffd6d6');
    if (!value) $('#convert-to-content').css('background', '#ffd6d6');
    if (!name || !value) {
      alert('Please select both Name and Value in Convert to.');
      return;
    }
    // Get selected user emails
    const checked = $('.user-select-checkbox:checked');
    if (checked.length === 0) {
      alert('Please select at least one user to convert.');
      return;
    }
    const emails = checked.map(function() { return $(this).data('email'); }).get();
    let nameLabel = name === 'status' ? 'Status' : 'Permission Level';
    let valueLabel = value;
    if (name === 'permission') {
      if (value == 1) valueLabel = 'Level 1 (Add/Edit)';
      if (value == 2) valueLabel = 'Level 2 (Add/Edit/Delete)';
      if (value == 3) valueLabel = 'Level 3 (Admin)';
    }
    if (name === 'status') {
      valueLabel = value.charAt(0).toUpperCase() + value.slice(1);
    }
    if (!confirm(`Confirm: The selected emails will be converted to ${nameLabel} = ${valueLabel}.`)) return;
    // Show updating overlay
    $('#updating-overlay').css('display', 'flex');
    // For each selected user, send AJAX to update
    let completed = 0;
    checked.each(function() {
      const id = $(this).data('id');
      let data = {};
      if (name === 'permission') data.permission_level = value;
      if (name === 'status') {
        data.is_approved = (value === 'Active' ? 1 : 0);
        if (value === 'Inactive') {
          // Also set permission_level for Inactive
          let currentLevel = $(this).data('level');
          data.permission_level = currentLevel ? currentLevel : 1;
        }
      }
      $.ajax({
        url: `/admin/users/${id}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(data),
        complete: function() {
          completed++;
          if (completed === checked.length) {
            setTimeout(function() {
              $('#updating-overlay').css('display', 'none');
              window.location.href = '/admin';
            }, 400);
          }
        }
      });
    });
  });
});
</script>
<div id="updating-overlay">
  <div class="spinner"></div>
  <div style="color:#fff;font-size:1.5rem;font-weight:600;">Updating...</div>
</div>
</body>
</html> 