<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Approval - Customer Management App</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .tab-content { background: #fff; padding: 32px 40px; border-radius: 10px; box-shadow: 0 2px 16px #eee; min-width: 600px; }
    .nav-tabs { justify-content: center; margin-bottom: 0; }
    .nav-tabs .nav-link { font-size: 18px; padding: 10px 32px; }
    .container { margin-top: 40px; display: flex; flex-direction: column; align-items: center; }
    h2 { margin-bottom: 24px; }
    #rules-list .rule-content { width: 220px !important; min-width: 220px; max-width: 220px; }
    #rules-list .rule-add, #rules-list .rule-del { width: 36px; min-width: 36px; max-width: 36px; text-align: center; padding-left: 0; padding-right: 0; }
    #rules-section-flex { display: flex; gap: 48px; align-items: flex-start; }
    .rules-panel, .convert-panel {
      background: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 2px 8px #e0e0e0;
      padding: 24px 20px 20px 20px;
      min-width: 340px;
      max-width: 520px;
      flex: 1;
    }
    .convert-panel {
      min-width: 240px;
      max-width: 400px;
      border-left: 3px solid #e0e0e0;
      display: none; /* Hide by default */
    }
    .convert-disabled {
      pointer-events: none;
      opacity: 0.5;
      filter: grayscale(0.2);
    }
    #updating-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    .spinner {
      border: 8px solid #f3f3f3;
      border-top: 8px solid #3498db;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 18px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .convert-panel-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      z-index: 10;
      border-radius: 10px;
      cursor: not-allowed;
      display: none;
    }
    .convert-panel.position-relative { position: relative; }
  </style>
</head>
<body>
<div class="container">
  <h2>Admin User Approvals</h2>
  <ul class="nav nav-tabs" id="adminTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="authorized-person-tab" data-toggle="tab" href="#authorized-person" role="tab">Authorized Person</a>
    </li>
  </ul>
  <div class="tab-content w-100" id="adminTabContent">
    <div class="tab-pane fade show active" id="authorized-person" role="tabpanel">
      <h3>Authorized Persons</h3>
      <div id="rules-section-flex">
        <div class="rules-panel" style="overflow-x:auto;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
            <label style="font-weight:600; font-size:1.1rem; margin-bottom:0;">Rules</label>
            <button class="btn btn-primary btn-sm rule-search">Search</button>
            <button class="btn btn-secondary btn-sm rule-cancel">Reset</button>
          </div>
          <div id="rules-list"></div>
        </div>
        <div id="convert-panel-container"></div>
      </div>
      <div id="user-filter-row" style="display:none;">
        <input id="user-filter-input" class="form-control" style="width:220px;display:inline-block;" placeholder="Filter by email...">
        <button class="btn btn-secondary btn-sm" id="batch-set-level">Set Level for Selected</button>
        <select id="batch-level-select" class="form-control" style="width:180px;display:inline-block;">
          <option value="">-- Select Level --</option>
          <option value="none">-- No Level --</option>
          <option value="1">Level 1 (Add/Edit)</option>
          <option value="2">Level 2 (Add/Edit/Delete)</option>
          <option value="3">Level 3 (Admin)</option>
        </select>
      </div>
      <table class="table" id="users-table">
        <thead>
          <tr>
            <th><input type="checkbox" id="select-all-users"></th>
            <th>Email</th>
            <th>Status</th>
            <th>Permission Level</th>
            <th>Last Updated</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal" tabindex="-1" role="dialog" id="userModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userModalTitle">Add User</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <div class="form-group">
            <label for="userEmail">Email</label>
            <input type="email" class="form-control" id="userEmail" required>
          </div>
          <div class="form-group">
            <label for="userLevel">Permission Level</label>
            <select class="form-control" id="userLevel">
              <option value="1">Level 1 (Add/Edit)</option>
              <option value="2">Level 2 (Add/Edit/Delete)</option>
              <option value="3">Level 3 (Admin)</option>
            </select>
          </div>
          <input type="hidden" id="userId">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="saveUserBtn">Save</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- jQuery (required for Bootstrap 4) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Custom App JS -->
<script src="/static/js/app.js"></script>
<script>
// --- Rules UI Logic ---
const ruleNameOptions = [
  { value: 'email', label: 'Email' },
  { value: 'status', label: 'Status' },
  { value: 'permission', label: 'Permission Level' }
];
const ruleConditionOptions = [
  { value: 'contains', label: 'contains' },
  { value: 'not_contains', label: 'not contains' },
  { value: 'starts_with', label: 'starts with' },
  { value: 'ends_with', label: 'ends with' },
  { value: 'equal', label: 'equal to' },
  { value: 'not_equal', label: 'not equal' }
];
const ruleStatusOptions = [
  { value: 'Active', label: 'Active' },
  { value: 'Inactive', label: 'Inactive' },
  { value: 'Pending', label: 'Pending' }
];
const rulePermOptions = [
  { value: '1', label: 'Level 1 (Add/Edit)' },
  { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
  { value: '3', label: 'Level 3 (Admin)' }
];
let rules = [ { name: '', condition: '', content: '' } ];
function renderRules() {
  const $list = $('#rules-list');
  $list.empty();
  const usedNames = rules.map(r => r.name);
  rules.forEach((rule, idx) => {
    // Only show unused names (except for this rule's current name)
    const availableNames = ruleNameOptions.filter(opt => !usedNames.includes(opt.value) || opt.value === rule.name);
    const nameSelect = `<select class=\"rule-name form-control\" style=\"width:140px;display:inline-block;\"><option value="">-- Select --</option>${availableNames.map(opt => `<option value=\"${opt.value}\"${rule.name===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    // Condition options depend on name
    let condOpts = ruleConditionOptions;
    if (rule.name === 'status' || rule.name === 'permission') {
      condOpts = ruleConditionOptions.filter(opt => opt.value === 'equal' || opt.value === 'not_equal');
    }
    const condSelect = `<select class=\"rule-cond form-control\" style=\"width:140px;display:inline-block;\"><option value="">-- Select --</option>${condOpts.map(opt => `<option value=\"${opt.value}\"${rule.condition===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    let contentField = '';
    if (rule.name === 'email') {
      contentField = `<input type=\"text\" class=\"rule-content form-control\" style=\"width:220px;display:inline-block;\" value=\"${rule.content||''}\" placeholder=\"Enter value...\">`;
    } else if (rule.name === 'status') {
      contentField = `<select class=\"rule-content form-control\" style=\"width:220px;display:inline-block;\"><option value="">-- Select --</option>${ruleStatusOptions.map(opt => `<option value=\"${opt.value}\"${rule.content===opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    } else if (rule.name === 'permission') {
      contentField = `<select class=\"rule-content form-control\" style=\"width:220px;display:inline-block;\"><option value="">-- Select --</option>${rulePermOptions.map(opt => `<option value=\"${opt.value}\"${rule.content==opt.value?' selected':''}>${opt.label}</option>`).join('')}</select>`;
    }
    let addBtn = '';
    let delBtn = '';
    if (idx === rules.length - 1) {
      addBtn = `<button class=\"btn btn-success btn-sm rule-add\" style=\"margin-left:8px;\">+</button>`;
      delBtn = idx > 0 ? `<button class=\"btn btn-danger btn-sm rule-del\" style=\"margin-left:4px;\">-</button>` : '';
    } else {
      delBtn = `<button class=\"btn btn-danger btn-sm rule-del\" style=\"margin-left:4px;\">-</button>`;
    }
    $list.append(`<div class=\"rule-row\" data-idx=\"${idx}\" style=\"display:flex;align-items:center;gap:8px;margin-bottom:8px;\">${nameSelect}${condSelect}${contentField}${addBtn}${delBtn}</div>`);
  });
}
$(document).ready(function() {
  // Always disable Convert to panel on page load
  setConvertPanelDisabled(true);
  if (typeof fetchAndRenderUsers === 'function') fetchAndRenderUsers(false);
  renderRules();
  // Ensure panel is completely removed on page load
  clearConvertPanel();
  
  // Initialize latestChanges from localStorage if available
  try {
    const changesCache = JSON.parse(localStorage.getItem('userChangesCache') || '{}');
    window.latestChanges = { ...changesCache, ...(window.latestChanges || {}) };
    console.log('Loaded changes from cache:', window.latestChanges);
  } catch (e) {
    console.error('Could not load changes from localStorage:', e);
    window.latestChanges = window.latestChanges || {};
  }
  
  $('#rules-list').on('change', '.rule-name', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    rules[idx].name = $(this).val();
    // Reset content when name changes
    rules[idx].content = '';
    renderRules();
  });
  $('#rules-list').on('change', '.rule-cond', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    rules[idx].condition = $(this).val();
  });
  $('#rules-list').on('input change', '.rule-content', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    rules[idx].content = $(this).val();
  });
  $('#rules-list').on('click', '.rule-add', function() {
    // Validate all fields before adding a new rule
    let allFilled = true;
    $('#rules-list .rule-row').each(function() {
      $(this).find('.form-control').css('background','');
      const name = $(this).find('.rule-name').val();
      const cond = $(this).find('.rule-cond').val();
      const content = $(this).find('.rule-content').val();
      if (!name || !cond || !content) {
        allFilled = false;
        if (!name) $(this).find('.rule-name').css('background','#ffd6d6');
        if (!cond) $(this).find('.rule-cond').css('background','#ffd6d6');
        if (!content) $(this).find('.rule-content').css('background','#ffd6d6');
      }
    });
    if (!allFilled) {
      alert('Please fill in all fields for every rule.');
      return;
    }
    // Find first unused name
    const usedNames = rules.map(r => r.name);
    let nextName = '';
    for (const opt of ruleNameOptions) {
      if (!usedNames.includes(opt.value)) {
        nextName = opt.value;
        break;
      }
    }
    let newRule = { name: nextName, condition: '', content: '' };
    // Negation logic for new rule content
    let prev = rules[rules.length-1];
    if (prev.name === 'status') {
      if (prev.content === 'Active') newRule.content = 'Inactive';
      else if (prev.content === 'Inactive') newRule.content = 'Active';
      else if (prev.content === 'Pending') newRule.content = 'Active';
      else newRule.content = 'Inactive';
    } else if (prev.name === 'permission') {
      if (prev.content === '1') newRule.content = '2';
      else if (prev.content === '2') newRule.content = '3';
      else if (prev.content === '3') newRule.content = '1';
      else newRule.content = '2';
    }
    rules.push(newRule);
    renderRules();
  });
  $('#rules-list').on('click', '.rule-del', function() {
    const idx = $(this).closest('.rule-row').data('idx');
    if (confirm('Are you sure you want to delete this rule?')) {
      rules.splice(idx, 1);
      renderRules();
    }
  });
  $(document).on('click', '.rule-search', function() {
    let allFilled = true;
    $('#rules-list .rule-row').each(function() {
      $(this).find('.form-control').css('background','');
      const name = $(this).find('.rule-name').val();
      const cond = $(this).find('.rule-cond').val();
      const content = $(this).find('.rule-content').val();
      if (!name || !cond || !content) {
        allFilled = false;
        if (!name) $(this).find('.rule-name').css('background','#ffd6d6');
        if (!cond) $(this).find('.rule-cond').css('background','#ffd6d6');
        if (!content) $(this).find('.rule-content').css('background','#ffd6d6');
      }
    });
    if (!allFilled) {
      alert('Please fill in all fields for every rule.');
      return;
    }
    // Send rules to backend for filtering
    $.ajax({
      url: '/admin/users/filter',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ rules }),
      success: function(res) {
        // Update user table with filtered results
        updateUserTable(res.users, true);
        
        // IMPORTANT: Explicitly check and render Convert panel if there are users
        if (res.users && res.users.length > 0) {
          // Initialize options, but don't set any active selection
          // The panel should start with --Select-- for all dropdowns
          
          // Initialize basic options without setting a selection
          window.convertToName = ''; // Empty means --Select--
          window.convertToContent = ''; // Empty means --Select--
          
          // Initialize Status options to defaults if not set
          window.convertToStatusOptions = ['Active', 'Inactive'];
          
          // Initialize Permission options
          window.convertToPermOptions = [
            { value: '1', label: 'Level 1 (Add/Edit)' },
            { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
            { value: '3', label: 'Level 3 (Admin)' }
          ];
          
          // Still calculate appropriate negation options for reference
          if (rules.length > 0) {
            const rule = rules[0];
            
            // Store rule type but don't auto-select it
            window.lastRuleType = rule.name;
            
            if (rule.name === 'status') {
              // Calculate appropriate status negation - but don't select it
              const allStatus = res.users.map(u => u.status);
              const uniqueStatus = [...new Set(allStatus)];
              
              console.log('Search results status values:', uniqueStatus);
              
              if (uniqueStatus.length === 1) {
                // Consistent, calculate negation
                const negationValue = (uniqueStatus[0] === 'Active') ? 'Inactive' : 'Active';
                window.statusNegationValue = negationValue;
                window.convertToStatusOptions = ['Active', 'Inactive']; // Keep both but don't select
              }
            } else if (rule.name === 'permission') {
              // ... similar logic for permission, store negation info but don't select ...
            } else if (rule.name === 'email') {
              // ... existing email handling ...
            }
          }
          
          console.log('Convert panel options after search:', {
            name: window.convertToName,
            content: window.convertToContent,
            statusOptions: window.convertToStatusOptions,
            permOptions: window.convertToPermOptions
          });
          
          // Force render the Convert panel after a short delay
          setTimeout(function() {
            renderConvertToRule();
            // Make sure the panel is visible
            $('.convert-panel').css('display', 'block');
          }, 100);
        } else {
          // No users found, ensure panel is removed
          clearConvertPanel();
        }
      },
      error: function() {
        alert('Error filtering users.');
        clearConvertPanel(); // Remove panel on error
      }
    });
  });
  $(document).on('click', '.rule-cancel', function() {
    clearConvertPanel(); // Remove panel on reset
    window.location.href = '/admin';
  });
  $('#select-all-users').prop('checked', false);
});

function updateUserTable(users, selectAllChecked = null) {
  const $tbody = $('#users-table tbody');
  $tbody.empty();
  if (!users.length) {
    $tbody.append('<tr><td colspan="6" class="text-center">No users found.</td></tr>');
    clearConvertPanel();
    return;
  }
  
  // For debugging - log all users data structure to see available fields
  console.log('User data from server:', users);
  
  users.forEach(u => {
    let lastUpdate = null;
    let updateType = '';
    let isClientSide = false;
    let changeDetails = '';
    
    // First check if we have a client-side timestamp for this user
    if (window.latestChanges && window.latestChanges[u.id]) {
      const change = window.latestChanges[u.id];
      lastUpdate = change.timestamp;
      updateType = change.field;
      isClientSide = true;
      changeDetails = `${change.oldValue} → ${change.newValue}`;
    } 
    // Otherwise check the server timestamps
    else if (u.last_updated) {
      lastUpdate = u.last_updated;
      updateType = 'Updated';
    } else if (u.updated_at) {
      lastUpdate = u.updated_at;
      updateType = 'Updated';
    } else if (u.last_login) {
      lastUpdate = u.last_login;
      updateType = 'Login';
    } else if (u.created_at) {
      lastUpdate = u.created_at;
      updateType = 'Created';
    } else if (u.registration_date) {
      lastUpdate = u.registration_date;
      updateType = 'Registered';
    } else if (u.approved_at) {
      lastUpdate = u.approved_at;
      updateType = 'Approved';
    }
    
    // Format the date and indicate if client-side
    let lastUpdated;
    if (lastUpdate) {
      const formattedDate = formatDateTime(lastUpdate);
      lastUpdated = isClientSide ? 
        `<span style="color:#d14;">${updateType}: ${changeDetails} - ${formattedDate} (just now)</span>` : 
        `${updateType}: ${formattedDate}`;
    } else {
      lastUpdated = 'No date available';
    }
    
    // Create quick edit buttons for single-user actions
    const actionButtons = `
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-primary quick-edit-btn" data-id="${u.id}" title="Quick Edit">
          <i class="fa fa-pencil"></i> Edit
        </button>
        <button class="btn btn-sm btn-outline-secondary toggle-status-btn" 
                data-id="${u.id}" 
                data-current="${u.status}"
                title="${u.status === 'Active' ? 'Make Inactive' : 'Make Active'}">
          ${u.status === 'Active' ? 'Deactivate' : 'Activate'}
        </button>
      </div>
    `;
    
    $tbody.append(`
      <tr>
        <td><input type=\"checkbox\" class=\"user-select-checkbox\" data-id=\"${u.id}\" data-email=\"${u.email}\" data-level=\"${u.permission_level || ''}\"></td>
        <td>${u.email}</td>
        <td>${u.status || ''}</td>
        <td>${u.permission_level || ''}</td>
        <td>${lastUpdated}</td>
        <td>${actionButtons}</td>
      </tr>
      <tr id="edit-row-${u.id}" class="edit-row" style="display:none;">
        <td colspan="6">
          <div class="card p-3 mb-0">
            <div class="form-row">
              <div class="col">
                <label>Status</label>
                <select class="form-control edit-status" data-id="${u.id}">
                  <option value="Active" ${u.status==='Active'?'selected':''}>Active</option>
                  <option value="Inactive" ${u.status==='Inactive'?'selected':''}>Inactive</option>
                </select>
              </div>
              <div class="col">
                <label>Permission Level</label>
                <select class="form-control edit-permission" data-id="${u.id}">
                  <option value="1" ${u.permission_level==1?'selected':''}>Level 1 (Add/Edit)</option>
                  <option value="2" ${u.permission_level==2?'selected':''}>Level 2 (Add/Edit/Delete)</option>
                  <option value="3" ${u.permission_level==3?'selected':''}>Level 3 (Admin)</option>
                </select>
              </div>
              <div class="col d-flex align-items-end">
                <button class="btn btn-success save-user-btn mr-2" data-id="${u.id}">Save</button>
                <button class="btn btn-secondary cancel-edit-btn" data-id="${u.id}">Cancel</button>
              </div>
            </div>
          </div>
        </td>
      </tr>
    `);
  });
  
  // Set checkboxes based on selectAllChecked param
  if (selectAllChecked === true) {
    $('#select-all-users').prop('checked', true);
    $('.user-select-checkbox:enabled').prop('checked', true);
  } else if (selectAllChecked === false) {
    $('#select-all-users').prop('checked', false);
    $('.user-select-checkbox:enabled').prop('checked', false);
  }
}

// Helper function to format date/time nicely
function formatDateTime(dateTimeStr) {
  try {
    const dt = new Date(dateTimeStr);
    if (isNaN(dt.getTime())) return 'Invalid date';
    
    // Format: "Apr 16, 2024 15:30"
    return dt.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (e) {
    console.error('Date parsing error:', e, 'for dateTimeStr:', dateTimeStr);
    return 'Unknown';
  }
}

// --- Convert to Preset Rule Logic ---
const convertNameOptions = [
  { value: 'status', label: 'Status' },
  { value: 'permission', label: 'Permission Level' }
];
const convertStatusOptions = [
  { value: 'Active', label: 'Active' },
  { value: 'Inactive', label: 'Inactive' }
];
const convertPermOptions = [
  { value: '1', label: 'Level 1 (Add/Edit)' },
  { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
  { value: '3', label: 'Level 3 (Admin)' }
];
function renderConvertToRule() {
  let name = window.convertToName || '';
  let content = window.convertToContent || '';
  
  // Debug: Log the current options
  console.log('Rendering Convert panel with:', { 
    name, 
    content, 
    permOptions: window.convertToPermOptions,
    statusOptions: window.convertToStatusOptions 
  });
  
  // Ensure status options are set even if they weren't initialized elsewhere
  if (!window.convertToStatusOptions || window.convertToStatusOptions.length === 0) {
    window.convertToStatusOptions = ['Active', 'Inactive'];
    console.log('Initializing missing status options');
  }
  
  // Create a dropdown that allows selection between Status and Permission Level
  let nameSelect = `<select id=\"convert-to-name\" class=\"form-control\" style=\"width:160px;display:inline-block;\">
    <option value=\"\"${name===''?' selected':''}>-- Select --</option>
    <option value=\"status\"${name==='status'?' selected':''}>Status</option>
    <option value=\"permission\"${name==='permission'?' selected':''}>Permission Level</option>
  </select>`;
  
  let condText = '<span style=\"width:40px;display:inline-block;text-align:center;font-weight:600;\">=</span>';
  
  // Prepare the content dropdown based on the selected name
  let contentSelect = '';
  if (name === 'status') {
    // Status must use text values
    if (!isNaN(content)) {
      content = '';
    }
    
    // Only show text status values - ensure options exist
    let statusOpts = window.convertToStatusOptions || ['Active', 'Inactive'];
    console.log('Using status options:', statusOpts);
    
    contentSelect = `<select id=\"convert-to-content\" class=\"form-control\" style=\"width:180px;display:inline-block;\">
      <option value=\"\"${content===''?' selected':''}>-- Select --</option>
      ${statusOpts.map(opt => `<option value=\"${opt}\"${content===opt?' selected':''}>${opt}</option>`).join('')}
    </select>`;
  } 
  else if (name === 'permission') {
    // Permission must use numeric levels
    if (content === 'Active' || content === 'Inactive') {
      content = '';
    }
    
    // If we're not in a "search with results" context, check selected rows now
    if (!window.convertToPermOptions || window.convertToPermOptions.length === 0) {
      const selectedPerms = $('.user-select-checkbox:checked').map(function() {
        return $(this).closest('tr').find('td:eq(3)').text().trim();
      }).get();
      
      if (selectedPerms.length > 0) {
        const uniquePerms = [...new Set(selectedPerms)];
        console.log('Selected permission levels:', uniquePerms);
        
        if (uniquePerms.length === 1) {
          // All selected rows have the same permission level
          // Force rebuild convertToPermOptions from scratch with the negation
          const currentLevel = uniquePerms[0];
          console.log('Single permission level detected:', currentLevel);
          
          // Explicitly create only the negation options
          window.convertToPermOptions = [];
          if (currentLevel !== '1' && currentLevel !== 1) {
            window.convertToPermOptions.push({ value: '1', label: 'Level 1 (Add/Edit)' });
          }
          if (currentLevel !== '2' && currentLevel !== 2) {
            window.convertToPermOptions.push({ value: '2', label: 'Level 2 (Add/Edit/Delete)' });
          }
          if (currentLevel !== '3' && currentLevel !== 3) {
            window.convertToPermOptions.push({ value: '3', label: 'Level 3 (Admin)' });
          }
        } else {
          // Mixed permissions, show all
          window.convertToPermOptions = [
            { value: '1', label: 'Level 1 (Add/Edit)' },
            { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
            { value: '3', label: 'Level 3 (Admin)' }
          ];
        }
      } else {
        // Default if no selection
        window.convertToPermOptions = [
          { value: '1', label: 'Level 1 (Add/Edit)' },
          { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
          { value: '3', label: 'Level 3 (Admin)' }
        ];
      }
    }
    
    console.log('Final permission options:', window.convertToPermOptions);
    
    // Render permission options
    contentSelect = `<select id=\"convert-to-content\" class=\"form-control\" style=\"width:220px;display:inline-block;\">
      <option value=\"\"${content===''?' selected':''}>-- Select --</option>
      ${window.convertToPermOptions.map(opt => `<option value=\"${opt.value}\"${content===opt.value?' selected':''}>${opt.label}</option>`).join('')}
    </select>`;
  }
  else {
    // Default to empty dropdown
    contentSelect = `<select id=\"convert-to-content\" class=\"form-control\" style=\"width:180px;display:inline-block;\" disabled>
      <option value=\"\">-- Select --</option>
    </select>`;
  }
  
  // Create the panel HTML with both field options available
  $('#convert-panel-container').html(`
    <div class="convert-panel">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <label style="font-weight:600; font-size:1.1rem; margin-bottom:0;">Convert to</label>
        <button class="btn btn-success btn-sm convert-change-btn">Change</button>
        <button class="btn btn-secondary btn-sm convert-reset-btn" style="margin-left:8px;">Reset</button>
      </div>
      <div id="convert-to-box">
        <div style="display:flex;align-items:center;gap:8px;">${nameSelect}${condText}${contentSelect}</div>
      </div>
    </div>
  `);
  
  // Force display
  $('.convert-panel').css('display', 'block');
}

// When user selects a dropdown and changes it
$(document).on('change', '#convert-to-name', function() {
  const newName = $(this).val();
  // On field type change, reset options to default for that type
  if (newName !== window.convertToName) {
    window.convertToName = newName;
    window.convertToContent = '';
    
    // Reset the specific options to default when switching field types
    if (newName === 'status') {
      // Always ensure we have status options
      if (!window.convertToStatusOptions || window.convertToStatusOptions.length === 0) {
        window.convertToStatusOptions = ['Active', 'Inactive'];
      }
      
      // Check if we have consistent search results
      const allStatus = $('.user-select-checkbox:checked').map(function() {
        const row = $(this).closest('tr');
        return row.find('td:eq(2)').text().trim(); // Status column
      }).get();
      
      if (allStatus.length > 0) {
        const uniqueStatus = [...new Set(allStatus)];
        if (uniqueStatus.length === 1) {
          // All selected users have same status, show opposite only
          window.convertToContent = (uniqueStatus[0] === 'Active') ? 'Inactive' : 'Active';
          window.convertToStatusOptions = [window.convertToContent]; // Only the negation
          console.log('Setting status negation only:', window.convertToStatusOptions);
        } else {
          // Mixed status, show all options
          window.convertToStatusOptions = ['Active', 'Inactive'];
        }
      } else {
        // Default if no selection
        window.convertToStatusOptions = ['Active', 'Inactive'];
      }
    } else if (newName === 'permission') {
      // Check if we have consistent search results for permission level
      const allPerms = $('.user-select-checkbox:checked').map(function() {
        const row = $(this).closest('tr');
        return row.find('td:eq(3)').text().trim(); // Permission Level column
      }).get();
      
      if (allPerms.length > 0) {
        const uniquePerms = [...new Set(allPerms)];
        if (uniquePerms.length === 1) {
          // All selected users have same permission level, show only negation options
          window.convertToPermOptions = convertPermOptions.filter(opt => 
            opt.value !== uniquePerms[0] && opt.value !== 'Active' && opt.value !== 'Inactive');
        } else {
          // Mixed permissions, show all options
          window.convertToPermOptions = convertPermOptions.filter(opt => 
            opt.value !== 'Active' && opt.value !== 'Inactive');
        }
      } else {
        // Default if no selection
        window.convertToPermOptions = convertPermOptions.filter(opt => 
          opt.value !== 'Active' && opt.value !== 'Inactive');
      }
    }
  }
  
  renderConvertToRule();
});

$(document).on('change', '#convert-to-content', function() {
  window.convertToContent = $(this).val();
});

// Re-add the click handler for the Change button
$(document).on('click', '.convert-change-btn', function() {
  const name = $('#convert-to-name').val();
  const value = $('#convert-to-content').val();
  
  // Reset backgrounds
  $('#convert-to-name').css('background', '');
  $('#convert-to-content').css('background', '');
  
  // Validate inputs
  if (!name) $('#convert-to-name').css('background', '#ffd6d6');
  if (!value) $('#convert-to-content').css('background', '#ffd6d6');
  if (!name || !value) {
    alert('Please select both Name and Value in Convert to.');
    return;
  }
  
  // Get selected user emails
  const checked = $('.user-select-checkbox:checked');
  if (checked.length === 0) {
    alert('Please select at least one user to convert.');
    return;
  }
  
  // Format labels for confirmation
  let nameLabel = name === 'status' ? 'Status' : 'Permission Level';
  let valueLabel = value;
  if (name === 'permission') {
    if (value == 1) valueLabel = 'Level 1 (Add/Edit)';
    if (value == 2) valueLabel = 'Level 2 (Add/Edit/Delete)';
    if (value == 3) valueLabel = 'Level 3 (Admin)';
  }
  if (name === 'status') {
    valueLabel = value.charAt(0).toUpperCase() + value.slice(1);
  }
  
  // Confirm action
  if (!confirm(`Confirm: The selected emails will be converted to ${nameLabel} = ${valueLabel}.`)) return;
  
  // Show updating overlay
  $('#updating-overlay').css('display', 'flex');
  
  // For each selected user, send AJAX to update
  let completed = 0;
  checked.each(function() {
    const id = $(this).data('id');
    let data = {};
    
    // Track which field was changed for display purposes
    let changeType = '';
    let oldValue = '';
    let newValue = '';
    
    // Get the current row to extract the current values
    const $row = $(this).closest('tr');
    
    if (name === 'permission') {
      const currentPermission = $row.find('td:eq(3)').text().trim();
      data.permission_level = value;
      changeType = 'Permission';
      oldValue = currentPermission;
      
      // Map numeric permission level to readable text
      if (value === '1') newValue = 'Level 1 (Add/Edit)';
      else if (value === '2') newValue = 'Level 2 (Add/Edit/Delete)';
      else if (value === '3') newValue = 'Level 3 (Admin)';
      else newValue = value;
    }
    if (name === 'status') {
      const currentStatus = $row.find('td:eq(2)').text().trim();
      data.is_approved = (value === 'Active' ? 1 : 0);
      changeType = 'Status';
      oldValue = currentStatus;
      newValue = value;
    }
    
    // Create a timestamp for this change
    const timestamp = new Date().toISOString();
    
    // Add a client-side timestamp to track when this change was made
    data.client_updated_at = timestamp;
    
    // Store the change in a temporary object to reference in the callback
    const changeInfo = {
      id: id,
      field: changeType,
      oldValue: oldValue,
      newValue: newValue,
      timestamp: timestamp
    };
    
    // Store this in a temporary object on the window
    window.latestChanges = window.latestChanges || {};
    window.latestChanges[id] = changeInfo;
    
    // Cache the change info in localStorage to persist across page refreshes
    try {
      const changesCache = JSON.parse(localStorage.getItem('userChangesCache') || '{}');
      changesCache[id] = changeInfo;
      localStorage.setItem('userChangesCache', JSON.stringify(changesCache));
    } catch (e) {
      console.error('Could not cache changes in localStorage:', e);
    }
    
    $.ajax({
      url: `/admin/users/${id}`,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify(data),
      success: function(response) {
        console.log(`User ${id} updated successfully:`, response);
      },
      error: function(error) {
        console.error(`Error updating user ${id}:`, error);
      },
      complete: function() {
        completed++;
        if (completed === checked.length) {
          setTimeout(function() {
            $('#updating-overlay').css('display', 'none');
            if (typeof fetchAndRenderUsers === 'function') {
              // After fetch, we'll apply our client-side timestamps if needed
              fetchAndRenderUsers(false);
            }
            
            // Reset all fields, panels, etc.
            rules = [ { name: '', condition: '', content: '' } ];
            renderRules();
            
            // Reset Convert to fields
            window.convertToName = '';
            window.convertToContent = '';
            
            // Hide the panel 
            clearConvertPanel();
            
            // Uncheck select all
            $('#select-all-users').prop('checked', false);
          }, 400);
        }
      }
    });
  });
});

function clearConvertPanel() {
  // Completely remove the panel from DOM
  $('#convert-panel-container').empty();
}

function setConvertPanelDisabled(disabled) {
  if (disabled) {
    $('.convert-panel').addClass('convert-disabled');
    $('#convert-to-box').empty(); // Remove dropdown fields but keep header and buttons
    $('.convert-change-btn, .convert-reset-btn').prop('disabled', true);
  } else {
    $('.convert-panel').removeClass('convert-disabled');
    $('.convert-change-btn, .convert-reset-btn').prop('disabled', false);
    // The dropdowns are added by renderConvertToRule
  }
}

function fetchAndRenderUsers(selectAllChecked = null) {
  // Use the same /admin/users/filter endpoint as search, with no filters
  $.ajax({
    url: '/admin/users/filter',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ rules: [] }),
    success: function(res) {
      let users = res.users || [];
      // Sort by approved_at descending (if available)
      users.sort((a, b) => {
        if (b.approved_at && a.approved_at) return b.approved_at.localeCompare(a.approved_at);
        return 0;
      });
      // Get filter value
      const filter = $('#user-filter-input').val() ? $('#user-filter-input').val().toLowerCase() : '';
      let filtered = users;
      if (filter) {
        filtered = filtered.filter(u => u.email.toLowerCase().includes(filter));
      }
      updateUserTable(filtered, selectAllChecked);
    }
  });
}

$(document).on('click', '.convert-reset-btn', function() {
  // Reset Convert to fields to blank and render with empty selection
  window.convertToName = '';
  window.convertToContent = '';
  // Force re-create both option arrays but with no selection
  window.convertToStatusOptions = ['Active', 'Inactive'];
  window.convertToPermOptions = [
    { value: '1', label: 'Level 1 (Add/Edit)' },
    { value: '2', label: 'Level 2 (Add/Edit/Delete)' },
    { value: '3', label: 'Level 3 (Admin)' }
  ];
  renderConvertToRule();
});

// Add event handlers for quick individual user editing
$(document).ready(function() {
  // Quick edit button - show the edit row
  $(document).on('click', '.quick-edit-btn', function() {
    const id = $(this).data('id');
    $(`#edit-row-${id}`).show();
    $(this).closest('tr').addClass('table-active');
    
    // Initially disable save button
    $(`.save-user-btn[data-id="${id}"]`).prop('disabled', true);
  });
  
  // Monitor changes in form fields
  $(document).on('change', '.edit-status, .edit-permission', function() {
    const id = $(this).data('id');
    checkForChanges(id);
  });
  
  // Cancel edit button
  $(document).on('click', '.cancel-edit-btn', function() {
    const id = $(this).data('id');
    $(`#edit-row-${id}`).hide();
    $(`tr[data-id="${id}"]`).removeClass('table-active');
  });
  
  // Toggle status button (quick action without opening edit form)
  $(document).on('click', '.toggle-status-btn', function() {
    const id = $(this).data('id');
    const currentStatus = $(this).data('current');
    const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
    const $row = $(this).closest('tr');
    const currentPermission = $row.find('td:eq(3)').text().trim();
    
    let confirmMessage = `Are you sure you want to change status to ${newStatus}?`;
    
    // For activating a pending account, add info about setting permission level
    if (currentStatus === 'Inactive' && (currentPermission === '' || !currentPermission)) {
      confirmMessage = 'This will activate the account and set permission level to 1. Continue?';
    }
    
    if (confirm(confirmMessage)) {
      // Show updating overlay
      $('#updating-overlay').css('display', 'flex');
      
      // Store the change info for tracking
      const timestamp = new Date().toISOString();
      const changeInfo = {
        id: id,
        field: 'Status',
        oldValue: currentStatus,
        newValue: newStatus,
        timestamp: timestamp
      };
      
      // Ensure we have the latestChanges object
      window.latestChanges = window.latestChanges || {};
      
      // Store this in window.latestChanges
      window.latestChanges[id] = changeInfo;
      
      // Cache the change info in localStorage to persist across page refreshes
      try {
        const changesCache = JSON.parse(localStorage.getItem('userChangesCache') || '{}');
        changesCache[id] = changeInfo;
        localStorage.setItem('userChangesCache', JSON.stringify(changesCache));
      } catch (e) {
        console.error('Could not cache changes in localStorage:', e);
      }
      
      // Send AJAX to update
      $.ajax({
        url: `/admin/users/${id}`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ 
          is_approved: (newStatus === 'Active' ? 1 : 0),
          client_updated_at: timestamp  // Send timestamp to server
        }),
        success: function(response) {
          console.log(`User ${id} status updated successfully:`, response);
        },
        error: function(error) {
          console.error(`Error updating user ${id}:`, error);
        },
        complete: function() {
          setTimeout(function() {
            $('#updating-overlay').css('display', 'none');
            // Refresh the user table
            if (typeof fetchAndRenderUsers === 'function') fetchAndRenderUsers(false);
          }, 400);
        }
      });
    }
  });
  
  // Save button for individual user edit
  $(document).on('click', '.save-user-btn', function() {
    const id = $(this).data('id');
    const newStatus = $(`select.edit-status[data-id="${id}"]`).val();
    const newPermission = $(`select.edit-permission[data-id="${id}"]`).val();
    
    // Get current values from the main row for change tracking
    const $row = $(this).closest('tr').prev('tr');
    const currentStatus = $row.find('td:eq(2)').text().trim();
    const currentPermission = $row.find('td:eq(3)').text().trim();
    
    // Show updating overlay
    $('#updating-overlay').css('display', 'flex');
    
    // Track changes for Last Updated column
    const changes = [];
    if (newStatus !== currentStatus) {
      changes.push({
        field: 'Status',
        oldValue: currentStatus,
        newValue: newStatus
      });
    }
    if (newPermission !== currentPermission) {
      changes.push({
        field: 'Permission',
        oldValue: currentPermission,
        newValue: newPermission
      });
    }
    
    // Only proceed if there are changes
    if (changes.length === 0) {
      $('#updating-overlay').css('display', 'none');
      $(`#edit-row-${id}`).hide();
      $row.removeClass('table-active');
      return;
    }
    
    // Create timestamp for the change
    const timestamp = new Date().toISOString();
    
    // Store the change info for tracking in Last Updated column
    const changeInfo = {
      id: id,
      field: changes.map(c => c.field).join(' & '),
      oldValue: changes.map(c => c.oldValue).join(' & '),
      newValue: changes.map(c => c.newValue).join(' & '),
      timestamp: timestamp
    };
    
    // Store this in temporary object on the window
    window.latestChanges = window.latestChanges || {};
    window.latestChanges[id] = changeInfo;
    
    // Cache the change info in localStorage to persist across page refreshes
    try {
      const changesCache = JSON.parse(localStorage.getItem('userChangesCache') || '{}');
      changesCache[id] = changeInfo;
      localStorage.setItem('userChangesCache', JSON.stringify(changesCache));
    } catch (e) {
      console.error('Could not cache changes in localStorage:', e);
    }
    
    // Send AJAX to update the user
    $.ajax({
      url: `/admin/users/${id}`,
      type: 'PUT',
      contentType: 'application/json',
      data: JSON.stringify({
        is_approved: (newStatus === 'Active' ? 1 : 0),
        permission_level: newPermission,
        client_updated_at: timestamp  // Send timestamp to server
      }),
      success: function(response) {
        console.log(`User ${id} updated successfully:`, response);
      },
      error: function(error) {
        console.error(`Error updating user ${id}:`, error);
      },
      complete: function() {
        setTimeout(function() {
          $('#updating-overlay').css('display', 'none');
          // Hide the edit row
          $(`#edit-row-${id}`).hide();
          // Refresh the user table
          if (typeof fetchAndRenderUsers === 'function') fetchAndRenderUsers(false);
        }, 400);
      }
    });
  });
});

// Add new function to check for changes and toggle save button state
function checkForChanges(id) {
  const newStatus = $(`select.edit-status[data-id="${id}"]`).val();
  const newPermission = $(`select.edit-permission[data-id="${id}"]`).val();
  
  // Get current values from the main row
  const $row = $(`#edit-row-${id}`).prev('tr');
  const currentStatus = $row.find('td:eq(2)').text().trim();
  const currentPermission = $row.find('td:eq(3)').text().trim();
  
  // Check if there are any changes
  const hasChanges = (newStatus !== currentStatus || newPermission !== currentPermission);
  
  // Enable/disable the save button based on changes
  $(`.save-user-btn[data-id="${id}"]`).prop('disabled', !hasChanges);
}
</script>
<div id="updating-overlay">
  <div class="spinner"></div>
  <div style="color:#fff;font-size:1.5rem;font-weight:600;">Updating...</div>
</div>
</body>
</html> 